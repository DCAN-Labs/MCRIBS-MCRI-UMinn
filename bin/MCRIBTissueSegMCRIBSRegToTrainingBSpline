#!/bin/bash

i=$1

P=`pwd`

# antsApplyTransforms -v -d 3 --input ${OUTPUTPREFIX}_t2w_restore.nii.gz --reference-image $TEMPLATEDIR/P${i}_t2.nii.gz \
# 	--transform [$TEMPLATEDIR/FinalP${i}0GenericAffine.mat,1] \
# 	--transform $TEMPLATEDIR/FinalP${i}1InverseWarp.nii.gz \
# 	--transform ${P}/${OUTPUTPREFIX}_skullstrip_regFinalWarp.nii.gz \
# 	--transform $TEMPLATEDIR/ALBERTsTemplate40ToTemplate1Warp.nii.gz \
# 	--transform [$TEMPLATEDIR/ALBERTsTemplate40ToTemplate0GenericAffine.mat,0] \
# 	--transform [${P}/${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg0GenericAffine.mat,1] \
# 	--transform ${P}/${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg1InverseWarp.nii.gz \
# 	--interpolation Linear \
# 	--output-data-type float \
# 	--output $TISSUESEGDIR/$SUBJID/aP${i}_t2to_$SUBJID.nii.gz

if [ ! -f "${OUTPUTPREFIX}_to_P${i}reg7InverseWarp.nii.gz" -a ! -f "${OUTPUTPREFIX}_to_P${i}regFinalInverseWarp.nii.gz" ]
then

	T=`mktemp -d`
	cd $T

	# use image -> template -> training as initialiser
	antsRegistration -v -d 3 -u 1 -w [ 0.025,0.975 ] --verbose 1 --float 1 --collapse-output-transforms 0 \
        --initial-moving-transform [$TEMPLATEDIR/FinalP${i}0GenericAffine.mat,1] \
		--initial-moving-transform $TEMPLATEDIR/FinalP${i}1InverseWarp.nii.gz \
		--initial-moving-transform ${P}/${OUTPUTPREFIX}_skullstrip_regFinalWarp.nii.gz \
		--initial-moving-transform $TEMPLATEDIR/ALBERTsTemplate40ToTemplate1Warp.nii.gz \
		--initial-moving-transform [$TEMPLATEDIR/ALBERTsTemplate40ToTemplate0GenericAffine.mat,0] \
		--initial-moving-transform [${P}/${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg0GenericAffine.mat,1] \
		--initial-moving-transform ${P}/${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg1InverseWarp.nii.gz \
		--transform BSplineSyN[0.25,5,0,3] \
		--metric MI[ $TEMPLATEDIR/P${i}_t2_brain.nii.gz,$P/${OUTPUTPREFIX}_t2w_restore_brain.nii.gz,0.5,128 ] \
		--metric Demons[ $TEMPLATEDIR/P${i}_dkt_gm_lh.nii.gz,${P}/${OUTPUTPREFIX}_segmentation_gm_sep_lh.nii.gz,1 ] \
		--metric Demons[ $TEMPLATEDIR/P${i}_dkt_gm_rh.nii.gz,${P}/${OUTPUTPREFIX}_segmentation_gm_sep_rh.nii.gz,1 ] \
		--metric Demons[ $TEMPLATEDIR/P${i}_dkt_wm_lh_drawem_region.nii.gz,${P}/${OUTPUTPREFIX}_segmentation_wm_sep_lh.nii.gz,2 ] \
		--metric Demons[ $TEMPLATEDIR/P${i}_dkt_wm_rh_drawem_region.nii.gz,${P}/${OUTPUTPREFIX}_segmentation_wm_sep_rh.nii.gz,2 ] \
		--metric Demons[ $TEMPLATEDIR/P${i}_vent_and_centre_bright.nii.gz,${P}/${OUTPUTPREFIX}_brightmask_kmeans_class3.nii.gz,0.1 ] \
		--metric Demons[ $TEMPLATEDIR/P${i}_dkt_cc.nii.gz,${P}/${OUTPUTPREFIX}_segmentation_cc.nii.gz,1 ] \
		--convergence [ 200x150x20x0,1e-6,50 ] --shrink-factors 6x4x2x1 --smoothing-sigmas 2x1x1x1vox --masks $TEMPLATEDIR/P${i}_reg_mask.nii.gz \
		--transform SyN[0.25,2,0] \
		--metric MI[ $TEMPLATEDIR/P${i}_t2_brain.nii.gz,$P/${OUTPUTPREFIX}_t2w_restore_brain.nii.gz,0.5,128 ] \
		--metric Demons[ $TEMPLATEDIR/P${i}_dkt_gm_lh.nii.gz,${P}/${OUTPUTPREFIX}_segmentation_gm_sep_lh.nii.gz,1 ] \
		--metric Demons[ $TEMPLATEDIR/P${i}_dkt_gm_rh.nii.gz,${P}/${OUTPUTPREFIX}_segmentation_gm_sep_rh.nii.gz,1 ] \
		--metric Demons[ $TEMPLATEDIR/P${i}_dkt_wm_lh_drawem_region.nii.gz,${P}/${OUTPUTPREFIX}_segmentation_wm_sep_lh.nii.gz,2 ] \
		--metric Demons[ $TEMPLATEDIR/P${i}_dkt_wm_rh_drawem_region.nii.gz,${P}/${OUTPUTPREFIX}_segmentation_wm_sep_rh.nii.gz,2 ] \
		--metric Demons[ $TEMPLATEDIR/P${i}_vent_and_centre_bright.nii.gz,${P}/${OUTPUTPREFIX}_brightmask_kmeans_class3.nii.gz,0.1 ] \
		--metric Demons[ $TEMPLATEDIR/P${i}_dkt_cc.nii.gz,${P}/${OUTPUTPREFIX}_segmentation_cc.nii.gz,1 ] \
		--convergence [ 200x150x20x0,1e-6,75 ] --shrink-factors 6x4x2x1 --smoothing-sigmas 2x1x1x1vox --masks $TEMPLATEDIR/P${i}_reg_mask.nii.gz \
		--output ${P}/${OUTPUTPREFIX}_to_P${i}reg

	cd $P
	rm -fr $T

fi

#--metric CC[ $TEMPLATEDIR/P${i}_t2_brain_dilated.nii.gz,$P/${OUTPUTPREFIX}_t2w_restore_brain_dilated.nii.gz,0.5,2 ] \

#exit
if [ ! -f "${OUTPUTPREFIX}_to_P${i}regFinalInverseWarp.nii.gz" ]
then	
	antsApplyTransforms -v -d 3 --reference-image $TEMPLATEDIR/P${i}_t2.nii.gz \
		--transform ${OUTPUTPREFIX}_to_P${i}reg7InverseWarp.nii.gz  \
		--transform ${OUTPUTPREFIX}_to_P${i}reg8InverseWarp.nii.gz  \
		--output [${OUTPUTPREFIX}_to_P${i}regFinalInverseWarp.nii.gz,1]

fi
rm -f ${OUTPUTPREFIX}_to_P${i}reg7InverseWarp.nii.gz ${OUTPUTPREFIX}_to_P${i}reg8InverseWarp.nii.gz 
rm -f ${OUTPUTPREFIX}_to_P${i}reg7Warp.nii.gz ${OUTPUTPREFIX}_to_P${i}reg8Warp.nii.gz 
	#--metric CC[ $TEMPLATEDIR/P${i}_t2_brain_dilated.nii.gz,$P/${OUTPUTPREFIX}_t2w_restore_brain_dilated.nii.gz,1,2 ] \

antsApplyTransforms -v -d 3 --reference-image ${OUTPUTPREFIX}_t2w_restore.nii.gz --input $TEMPLATEDIR/P${i}_t2.nii.gz \
	--transform ${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg1Warp.nii.gz \
	--transform [${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg0GenericAffine.mat,0] \
	--transform [$TEMPLATEDIR/ALBERTsTemplate40ToTemplate0GenericAffine.mat,1] \
	--transform $TEMPLATEDIR/ALBERTsTemplate40ToTemplate1InverseWarp.nii.gz \
	--transform ${OUTPUTPREFIX}_skullstrip_regFinalInverseWarp.nii.gz \
	--transform $TEMPLATEDIR/FinalP${i}1Warp.nii.gz \
	--transform [$TEMPLATEDIR/FinalP${i}0GenericAffine.mat,0] \
	--transform ${OUTPUTPREFIX}_to_P${i}regFinalInverseWarp.nii.gz \
	--interpolation Linear \
	--output-data-type float \
	--output $TISSUESEGDIR/$SUBJID/P${i}_t2to_$SUBJID.nii.gz
# antsApplyTransforms -v -d 3 --reference-image ${OUTPUTPREFIX}_t2w_restore.nii.gz --input $TEMPLATEDIR/P${i}_vent_and_centre_bright.nii.gz \
# 	--transform ${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg1Warp.nii.gz \
# 	--transform [${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg0GenericAffine.mat,0] \
# 	--transform [$TEMPLATEDIR/ALBERTsTemplate40ToTemplate0GenericAffine.mat,1] \
# 	--transform $TEMPLATEDIR/ALBERTsTemplate40ToTemplate1InverseWarp.nii.gz \
# 	--transform ${OUTPUTPREFIX}_skullstrip_regFinalInverseWarp.nii.gz \
# 	--transform $TEMPLATEDIR/FinalP${i}1Warp.nii.gz \
# 	--transform [$TEMPLATEDIR/FinalP${i}0GenericAffine.mat,0] \
# 	--transform ${OUTPUTPREFIX}_to_P${i}regFinalInverseWarp.nii.gz \
# 	--interpolation GenericLabel \
# 	--output-data-type short \
# 	--output $TISSUESEGDIR/$SUBJID/P${i}_vent_and_centre_bright_to_$SUBJID.nii.gz
antsApplyTransforms -v -d 3 --reference-image ${OUTPUTPREFIX}_t2w_restore.nii.gz --input $TEMPLATEDIR/P${i}_dkt_with_skull_label.nii.gz \
	--transform ${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg1Warp.nii.gz \
	--transform [${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg0GenericAffine.mat,0] \
	--transform [$TEMPLATEDIR/ALBERTsTemplate40ToTemplate0GenericAffine.mat,1] \
	--transform $TEMPLATEDIR/ALBERTsTemplate40ToTemplate1InverseWarp.nii.gz \
	--transform ${OUTPUTPREFIX}_skullstrip_regFinalInverseWarp.nii.gz \
	--transform $TEMPLATEDIR/FinalP${i}1Warp.nii.gz \
	--transform [$TEMPLATEDIR/FinalP${i}0GenericAffine.mat,0] \
	--transform ${OUTPUTPREFIX}_to_P${i}regFinalInverseWarp.nii.gz \
	--interpolation GenericLabel \
	--output-data-type short \
	--output $TISSUESEGDIR/$SUBJID/P${i}_dkt_with_skull_label_to_$SUBJID.nii.gz
# antsApplyTransforms -v -d 3 --reference-image ${OUTPUTPREFIX}_t2w_restore.nii.gz --input $TEMPLATEDIR/P${i}_dkt_gm_lh.nii.gz \
# 	--transform ${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg1Warp.nii.gz \
# 	--transform [${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg0GenericAffine.mat,0] \
# 	--transform [$TEMPLATEDIR/ALBERTsTemplate40ToTemplate0GenericAffine.mat,1] \
# 	--transform $TEMPLATEDIR/ALBERTsTemplate40ToTemplate1InverseWarp.nii.gz \
# 	--transform ${OUTPUTPREFIX}_skullstrip_regFinalInverseWarp.nii.gz \
# 	--transform $TEMPLATEDIR/FinalP${i}1Warp.nii.gz \
# 	--transform [$TEMPLATEDIR/FinalP${i}0GenericAffine.mat,0] \
# 	--transform ${OUTPUTPREFIX}_to_P${i}regFinalInverseWarp.nii.gz \
# 	--interpolation GenericLabel \
# 	--output-data-type short \
# 	--output $TISSUESEGDIR/$SUBJID/P${i}_dkt_gm_lhwith_skull_label_to_$SUBJID.nii.gz
# antsApplyTransforms -v -d 3 --reference-image ${OUTPUTPREFIX}_t2w_restore.nii.gz --input $TEMPLATEDIR/P${i}_dkt_gm_rh.nii.gz \
# 	--transform ${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg1Warp.nii.gz \
# 	--transform [${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg0GenericAffine.mat,0] \
# 	--transform [$TEMPLATEDIR/ALBERTsTemplate40ToTemplate0GenericAffine.mat,1] \
# 	--transform $TEMPLATEDIR/ALBERTsTemplate40ToTemplate1InverseWarp.nii.gz \
# 	--transform ${OUTPUTPREFIX}_skullstrip_regFinalInverseWarp.nii.gz \
# 	--transform $TEMPLATEDIR/FinalP${i}1Warp.nii.gz \
# 	--transform [$TEMPLATEDIR/FinalP${i}0GenericAffine.mat,0] \
# 	--transform ${OUTPUTPREFIX}_to_P${i}regFinalInverseWarp.nii.gz \
# 	--output-data-type short \
# 	--output $TISSUESEGDIR/$SUBJID/P${i}_dkt_gm_rhwith_skull_label_to_$SUBJID.nii.gz
# antsApplyTransforms -v -d 3 --reference-image ${OUTPUTPREFIX}_t2w_restore.nii.gz --input $TEMPLATEDIR/P${i}_dkt_wm_lh_drawem_region.nii.gz \
# 	--transform ${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg1Warp.nii.gz \
# 	--transform [${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg0GenericAffine.mat,0] \
# 	--transform [$TEMPLATEDIR/ALBERTsTemplate40ToTemplate0GenericAffine.mat,1] \
# 	--transform $TEMPLATEDIR/ALBERTsTemplate40ToTemplate1InverseWarp.nii.gz \
# 	--transform ${OUTPUTPREFIX}_skullstrip_regFinalInverseWarp.nii.gz \
# 	--transform $TEMPLATEDIR/FinalP${i}1Warp.nii.gz \
# 	--transform [$TEMPLATEDIR/FinalP${i}0GenericAffine.mat,0] \
# 	--transform ${OUTPUTPREFIX}_to_P${i}regFinalInverseWarp.nii.gz \
# 	--interpolation GenericLabel \
# 	--output-data-type short \
# 	--output $TISSUESEGDIR/$SUBJID/P${i}_dkt_wm_lhwith_skull_label_to_$SUBJID.nii.gz
# antsApplyTransforms -v -d 3 --reference-image ${OUTPUTPREFIX}_t2w_restore.nii.gz --input $TEMPLATEDIR/P${i}_dkt_wm_rh_drawem_region.nii.gz \
# 	--transform ${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg1Warp.nii.gz \
# 	--transform [${OUTPUTPREFIX}_alberts_to_native_skullstrip_reg0GenericAffine.mat,0] \
# 	--transform [$TEMPLATEDIR/ALBERTsTemplate40ToTemplate0GenericAffine.mat,1] \
# 	--transform $TEMPLATEDIR/ALBERTsTemplate40ToTemplate1InverseWarp.nii.gz \
# 	--transform ${OUTPUTPREFIX}_skullstrip_regFinalInverseWarp.nii.gz \
# 	--transform $TEMPLATEDIR/FinalP${i}1Warp.nii.gz \
# 	--transform [$TEMPLATEDIR/FinalP${i}0GenericAffine.mat,0] \
# 	--transform ${OUTPUTPREFIX}_to_P${i}regFinalInverseWarp.nii.gz \
# 	--interpolation GenericLabel \
# 	--output-data-type short \
# 	--output $TISSUESEGDIR/$SUBJID/P${i}_dkt_wm_rhwith_skull_label_to_$SUBJID.nii.gz


# for debugging, can comment out
MRIBinarize --i $TISSUESEGDIR/$SUBJID/P${i}_dkt_with_skull_label_to_$SUBJID.nii.gz --o $TISSUESEGDIR/$SUBJID/P${i}_dkt_gm_lhwith_skull_label_to_$SUBJID.nii.gz --min 1000 --max 1035 --noverbose
MRIBinarize --i $TISSUESEGDIR/$SUBJID/P${i}_dkt_with_skull_label_to_$SUBJID.nii.gz --o $TISSUESEGDIR/$SUBJID/P${i}_dkt_gm_rhwith_skull_label_to_$SUBJID.nii.gz --min 2000 --max 2035 --noverbose
MRIBinarize --i $TISSUESEGDIR/$SUBJID/P${i}_dkt_gm_rhwith_skull_label_to_$SUBJID.nii.gz --o $TISSUESEGDIR/$SUBJID/P${i}_dkt_gm_rhwith_skull_label_to_$SUBJID.nii.gz --match 1 --binval 4 --noverbose
MRIBinarize --i $TISSUESEGDIR/$SUBJID/P${i}_dkt_gm_lhwith_skull_label_to_$SUBJID.nii.gz --o $TISSUESEGDIR/$SUBJID/P${i}_dkt_gm_lhwith_skull_label_to_$SUBJID.nii.gz --match 1 --binval 9 --noverbose
fslmaths $TISSUESEGDIR/$SUBJID/P${i}_dkt_gm_rhwith_skull_label_to_$SUBJID.nii.gz -add $TISSUESEGDIR/$SUBJID/P${i}_dkt_gm_lhwith_skull_label_to_$SUBJID.nii.gz $TISSUESEGDIR/$SUBJID/P${i}_dkt_gmwith_skull_label_to_$SUBJID.nii.gz -odt char
rm -f $TISSUESEGDIR/$SUBJID/P${i}_dkt_gm_rhwith_skull_label_to_$SUBJID.nii.gz $TISSUESEGDIR/$SUBJID/P${i}_dkt_gm_lhwith_skull_label_to_$SUBJID.nii.gz